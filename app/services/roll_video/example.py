#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
滚动视频服务使用示例
"""

import os
import logging
import time
from roll_video_service import RollVideoService

# 配置日志
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    handlers=[logging.StreamHandler()]
)
logger = logging.getLogger(__name__)

def main():
    # 示例文本
    sample_text = """
    情断梨梦
我相中了父亲身边年轻俊美的副官。

那时我并不知，他已有娃娃亲。

婚后五年，他成了权倾一方的军阀。

找到失散的青梅，执意娶她为妻。

言语里尽是恼恨：

「若非你执意要嫁，我妻始终只会是初梨一人。」

我伤心难忍，默默买了去上海的船票。

后来，一日又一日。

夏槐川终于忍不住，要亲自接人回来。

却看见了刊登报上的离婚声明。

1

夏槐川带回青梅这日。

偏不巧，是他的生辰。

此前我足足忙活了一个月。

请人为他裁制新衣、重金礼聘名角唱戏、写下五百封邀请函……

可那日——

他失踪了。

整整一个白日，我疲于迎来送往，焦急他的安危。

而他正同青梅温存缠绵，道不尽相思苦。

不知情的我，还强撑着微笑，同贵客一一编出托辞。

「督军昨儿说，觅得了法国的波尔多梨，要亲自送来，想来路上耽搁了。」

众人纷纷举杯含笑：

「督军真疼爱夫人，千金运梨，只为博夫人欢心。」

也就是这时，宴会厅门口一阵哗然。

我回首，瞧见士兵簇拥之中，身着笔挺军装的修长身影。

顾不上仪态，我穿过熙攘人群，朝着他奔去，只想确认他是否安然。

却对上了一双如视仇人的冰冷眼眸。

还有依偎在他身侧，恰似娇柔菟丝花的柔弱女子。

「正巧渝城的各界名流都在。」

夏槐川扫视满堂宾客，薄唇微勾，继而说道：

「七日之后，我将迎娶沈初梨为妻。

「我与初梨青梅竹马，两情相悦。

「还望婚礼之上，各位贵宾大驾光临。」

我如遭雷劈，呆立原地。

所有人目光落在我身上，怜悯的、看戏的、嘲弄的……

满堂祝贺声里，夏槐川踩着军靴走来，居高临下地俯身。

掐住我下巴，逼着我对视。

语气分外冰冷：

「二姨太，莫不是忘了礼数？不知给夫人行礼？」

2

不出一日，消息随着报纸飞遍渝城。

人人笑话我沦为妾室，感叹有情人终成眷属。

沈初梨这些年沦落卖唱。

夏槐川怜惜她，一门心思想要补偿。

听丫鬟晓玥讲：

「督军让那女人搬进了办公楼同住……

「督军请了何记的掌柜，陪着看了一天的婚纱……」

「督军带人去凤祥和，亲自挑了一天的首饰……」

这些事，我们成婚时，他从未做过。

原来，军务繁忙是假。

只是，我不值得。

……

我伤心了整整三日。

第四日顶着红肿的眼睛醒来。

正值寒冬将去，窗外梨花，一夜繁开。

我恍惚忆起。

曾有人在满堂哄笑里，坚定地说：

「十八房姨太太有什么意思？我只要一人，白首到老。」

我知道，这段五年的婚姻，该结束了。

3

午后。

夏槐川刚检阅完军队，就匆匆赶回督军府陪沈初梨。

戎装还沾着雪。

整个西南闻风丧胆的军阀，躬身给端坐的女人编辫子。

脸上是我从未见过的浅浅笑意。

「嘶——夏槐川，你弄疼我了。」

女人嗔怪一声，转头亲昵地拍男人的手臂。

她瞧见了门口的我，娇怯地缩进身后男人的怀里。

夏槐川眼神瞬间冷下来，嗓音疏离：

「有事？」

我垂眸掩下神伤。

整整五年，他冷淡至极，原来并非本性使然，只是不爱。

我开口，嗓音沙哑：

「有亲人要去往上海，身份特殊，须得一封通行证。」

我说话时，夏槐川垂眸。

拿惯了枪的手，娴熟地在辫尾系上红发绳。

听见我的话，英挺的眉骨皱起，语气冷淡：

「这般小事，往后不必再来烦我。」

随即接过钢笔，在我手中的文件签下字。

他的目光始终停留在沈初梨身上。

甚至未曾察觉，我用袖口遮掩的名字。

是「宋温玉」。

我转身离开，有些落寞。

身后传来沈初梨柔柔的嗓音。

「槐川，把手上的红绳解了吧。

「七年前送你的，快磨烂了还戴着，也不怕旁人笑话。」

心口突然一阵刺痛。

这红绳……

原来如此。

4

五年前，新婚燕尔，夏槐川主动请缨出兵。

我一步一叩首，沿着千级台阶登上寺庙，为他求得平安符。

他没接，挽起袖子。

露出的手腕上，缠着女子的红发绳。

他说：「母亲遗物已能庇佑平安，无需再添。」

原来，那并非母亲的遗物。

少年远去参军，心上人剪断发绳。

一半绞着她的辫子，一半牵着他的心脏。

他许诺，国家安定之日，定回来娶她。

那……

夏槐川，在你心里。

陪你从籍籍无名到功成名就的宋温玉，究竟又算什么？

五年相伴。

她知你冷暖，寒有秋衣，热有凉饮。

她知你心志，虽喜静少言，却逼着自己周旋名流，为你拓宽人脉。

她这辈子娇生惯养，但被你的仇敌掳去，整整七日，针扎指尖、坐老虎凳……

七尺男儿都痛哭招供，她却紧咬牙关，只字未吐。

这样的她。

只算得上你和她戏里，拆散苦命鸳鸯的恶人吗？

5

我不是拖泥带水的性子。

让晓玥一早出门，买了最近的船票。

三日后，恰是他们大婚之日。

又将夏槐川从前所赠之物，一一收起。

不多，一个小皮箱足以装下。

「太太，这也要当掉吗？

「这是督军当初亲自给您打的婚戒啊。」

晓玥问道。

我苦笑一下，点点头。

她红了眼，夹着哭音说：

「督军真是没长眼。

「咱们小姐相貌、才学、品行，哪样不是一等一的。

「那个女人，堂子里出来的，什么都不懂！」

「不可妄语。」

我止住了她的话头，怕小姑娘惹出祸端。

等晓玥去了当铺。

窗外忽然飘起梨花，如霰如雪。

我猛地想起什么，抬手摘下鬓边的梨蕊珠花。

手指渐渐收紧。

许久，才长叹一声，松了手。

手心被珠花下的金属夹刺伤，现出一抹血色。

6

离开前两日，我去了法无寺，将当掉的钱悉数捐掉。

寺庙收留了许多无家可归的孩子。

为感谢，住持赠我开过光的护身符。

抬脚跨出院门时。

一众骑兵，风驰电掣般驰至寺庙前。

为首之人，正是夏槐川。

香客纷纷避让，拥挤的道路让出空地。

夏槐川身着笔挺军装，勒住缰绳，利落地翻身下马，军靴稳稳踏在地上。

他伸出双手。

剑眉之下，薄唇微扬：

「放心，有我接着。」

马背上，沈梨初面若桃花，笑意盈盈地跌落他怀中。

北风乍起。

我紧了紧披肩，捂着嘴低低咳了声。

「二姨太，你怎么在这儿？」

沈梨初突然转头看向我，娇声问道。

「二姨太」三个字，她咬得很深。

夏槐川目光冷峻地打量着我，落在我手中的护身符上。

当着一众好事者的面，丝毫不留情面：

「这护身符，我说过不需要，你既求来了，便献给夫人吧。」

本来也不是给他的，听他这般说，我还是止不住难过。

艰难地吐出两个字。

「不行……」

夏槐川没说什么，比了比手势。

身旁的勤务兵，端着枪，趾高气扬地逼近。

「得罪了，二姨太。」

我看着夏槐川，突然笑了，松了手。

护身符掉在地上。

我迈步离开。

擦肩而过时，却被一把拽住手腕。

夏槐川垂下眼睫，冷冷睨着我。

皮质手套冰凉刺骨，力道大到像要捏碎腕骨。

「去，捡起来。」

「槐川……」

沈初梨扯了扯他的袖子，怯生生地说：

「宋家小姐不愿让我进门，不给就算了。」

钳着我手腕的力道又多了几分。

夏槐川忽然像是察觉到什么。

喉结滚动，像审问奸细般逼问：

「你手上的婚戒呢？」

我怔愣住，没想到他竟会留意到。

随口骗他：「圈口断了，叫人修补去了。」

他凸起的眉骨微展。

身后，沈梨初嘴角撇了下来。

变故就是那一瞬发生的。

7

刹那间，枪声大作。

夏槐川重重地丢开我，任由我踉跄着摔倒在地，手心擦出血痕。

枪声、尖叫、哭声……

混成一团。

我眨着酸红的眼眶，清楚地看见。

他以自身血肉为盾牌，将沈初梨紧紧护在怀中。

子弹贯穿了他的肩膀。

殷红的鲜血迅速洇染了普鲁士蓝的军装。

他只抿紧了唇，眉头都没皱一下。

一手按着怀中人的后脑，另一手迅速掏出勃朗宁反击。

片刻之间，硝烟散尽。

士兵们将方才隐匿在香客中的杀手，押成一排。

夏槐川收起配枪，神色冷峻如煞神，下令道：

「押回警务局，我要亲自审问。」

沈梨初失声惊呼：「槐川！你的肩膀！」

夏槐川抬手轻抚她的发丝，柔声安慰：

「无妨，快离开这。」

「那二姨太呢？要带她一起吗？她也受伤了。」

夏槐川冷冷地瞥过来。

对我满身的狼狈视而不见。

踩着军靴，径直从我面前走过，头也不回地离去。

心里最后一丝留恋，也烟消殆尽了。

回了督军府，我院里的丫鬟奶妈都不见踪影。

8

管家回我，面有不忍：

「夫人……督军抓了所有人，去了警务局。」

我身形一晃，险些站立不稳。

警务局，那是吃人的地方。

再嘴硬的奸细也会皮开肉绽，张口说话。

我在办公楼外等了许久。

披肩上积了一重雪，才有勤务兵打开大门。

沙发上，夏槐川袒露着精壮的上身，胸前裹了一圈绷带。

他怀里，沈初梨旗袍领口凌乱，双颊绯红。

我直直地盯着他，张开快冻冰的唇：

「夏槐川……

「你把她们放了，你清楚与我无关。」

男人充耳不闻。

若无其事地俯身，吻住沈初梨的双唇。

唇齿交缠，水声暧昧。

在沈初梨的娇嗔里结束。

「槐川，二姨太看着呢。」

他这才撩起薄薄的眼皮看过来，语气冷淡：

「等我审问结果出来，自然放她们回去。」

我咬紧下唇。

两年前，父亲去世。

他收拢了父亲大批部下，还扩张了势力范围。

如今我好像真没什么可威胁他，连命也是。

「徐老……

「带二姨太出去，半小时后人会送回。」

我不可置信地抬头。

夏槐川说完那话，就起身离开，只留给我一个背影。

他身后，沈初梨阴沉地剜了我一眼。

直到管家递过来手帕，我才反应过来，脸上满是湿泪。

回去路上，老管家劝我：

「夫人，老奴瞧得出，督军心里有您。

「您一掉泪，督军这不就心软了。

「只是沈家于他有恩，他负了沈小姐，让她沦落为歌女，沈家二老也遭遇不测，他心里愧疚。

「且等些时日再看……」

我听着他絮叨，苍凉笑笑，没接话。

谁都明白，夏槐川此番是在杀鸡儆猴。

他太在乎她，舍不得她受半点伤害。

他是在警告我，但凡敢动她，下场当如此。
"""

    # 路径
    output_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), "output")
    os.makedirs(output_dir, exist_ok=True)

    # 创建服务实例
    service = RollVideoService()

    # 定义测试场景参数列表
    test_cases = [
        {
            # 不透明 -> 自动尝试 GPU (h264_nvenc) -> 输出 .mp4
            "description": "白底黑字（自动GPU -> MP4）",
            "params": {
                "text": sample_text,
                "width": 450,
                "height": 700,
                "font_path": "方正黑体简体.ttf",
                "font_size": 24,
                "font_color": (0, 0, 0),
                "bg_color": (255, 255, 255, 1.0), # 不透明
                "line_spacing": int(24 * 3) - 24,
                "char_spacing": 5,
                "fps": 30,
                "scroll_speed": 1,
            }
        },
        {
            # 透明背景 -> 自动使用 CPU (prores_ks) -> 输出 .mov
            "description": "透明背景黑字（自动CPU -> MOV）",
            "params": {
                "text": sample_text,  # 使用较少文字以加快测试
                "width": 450,
                "height": 700,
                "font_path": "方正黑体简体.ttf",
                "font_size": 24,
                "font_color": (0, 0, 0),
                "bg_color": (255, 255, 255, 0.5),  # 半透明背景
                "line_spacing": int(24 * 1.5),
                "char_spacing": 5,
                "fps": 30,
                "scroll_speed": 2,  # 较快的滚动速度
                "worker_threads": 4  # 指定工作线程数
            }
        }
    ]

    # 循环生成不同场景的视频
    for i, test_case in enumerate(test_cases):
        logger.info(f"--- 开始生成场景 {i+1}: {test_case['description']} ---")
        
        # 输出文件名不再需要指定扩展名，Service 会自动处理
        # 但我们仍然需要一个基础的文件名
        base_file_name = f"test_case_{i+1}_{time.strftime('%Y%m%d_%H%M%S')}"
        # 传递一个带任意（或无）扩展名的路径给 Service
        output_path_base = os.path.join(output_dir, base_file_name + ".tmp") 

        # 调用服务创建滚动视频
        # 使用 **test_case['params'] 来传递所有参数
        result = service.create_roll_video(
            output_path=output_path_base, # Service 会修正扩展名
            **test_case['params'] 
        )

        # 输出结果
        if result["status"] == "success":
            logger.info(f"场景 {i+1} 成功: {result['message']}")
            logger.info(f"最终输出视频路径: {result['output_path']}") # 注意这里是最终路径
        else:
            logger.error(f"场景 {i+1} 失败: {result['message']}")

        logger.info(f"--- 场景 {i+1} 生成结束 ---")

if __name__ == "__main__":
    main()